# 设计说明

## 1) QPS 精确控制：令牌桶（Token Bucket）

- 每秒按目标 QPS 往桶里加 token（支持小数 QPS）
- 发请求必须先拿 token
- token 用完就等待下一轮 refill

## 2) 并发精确控制：Semaphore

- 每个请求发送前 acquire
- 完成后 release
- 保证在途请求数 ≤ concurrency

## 3) 非匀速模拟（你要的随机节奏）

我们提供三种可叠加的“非匀速”机制：

1. **抖动（jitter）**：每次请求间隔加随机偏移（毫秒级）
2. **空窗（pause window）**：随机进入“暂停模式”，比如暂停 1–5s（几秒 1 次的感觉）
3. **突发（burst）**：随机进入“突发模式”，短时间 QPS × N，比如 1–2s 内打 3 倍 QPS（1s 几次的感觉）



# 使用说明：怎么调出“像产线一样不匀速”

你说的“有时候 1s 几次，有时候几秒 1 次”，建议这样配：

- 平均 QPS 先设成 5~10
- burst 概率 10%，持续 0.8~1.8s，倍数 2~4
- pause 概率 6%，持续 1.2~4.5s
- jitter 100~300ms

这就会出现你描述的节奏。

------

# 额外建议（更像真实生产）

如果你们 trans 还有“随机丢请求/重试/批量”的特性，也可以继续加：

- 失败后概率性重试（带指数退避）
- 请求 payload 大小随机（模拟真实 body）
- 部分请求故意走慢路径

你需要的话我可以在上面的 trans 中继续加。